name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build:
    runs-on: ubuntu-24.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          git \
          python3 \
          python3-pip \
          pkg-config \
          libssl-dev \
          zlib1g-dev \
          libtcmalloc-minimal4 \
          uuid-dev \
          tcl-dev \
          libffi-dev \
          libreadline-dev \
          bison \
          flex \
          libfl-dev \
          libunwind-dev \
          libgoogle-perftools-dev \
          ccache

    - name: Setup GCC-9
      shell: bash
      run: |
        # Install and setup gcc-9
        sudo apt install -y g++-9
        sudo ln -sf /usr/bin/g++-9 /usr/bin/g++
        sudo ln -sf /usr/bin/gcc-9 /usr/bin/gcc
        sudo ln -sf /usr/bin/gcov-9 /usr/bin/gcov

    - name: Setup ccache
      uses: hendrikmuhs/ccache-action@v1.2
      with:
        key: build-${{ runner.os }}
        max-size: 2G

    - name: Install Python dependencies
      run: |
        pip3 install orderedmultidict

    - name: Setup ccache environment
      run: |
        echo "CC=ccache gcc" >> $GITHUB_ENV
        echo "CXX=ccache g++" >> $GITHUB_ENV
        ccache --set-config=cache_dir=$HOME/.ccache
        ccache --set-config=max_size=2G
        ccache --set-config=compression=true
        ccache --zero-stats

    - name: Build project
      run: |
        # Clean any potential cmake cache that might have wrong compiler info
        rm -rf build/CMakeCache.txt build/CMakeFiles/
        # Explicitly pass compiler to make/cmake
        make -j4 CC="ccache gcc" CXX="ccache g++" CPU_CORES=4

    - name: Print ccache statistics
      run: |
        ccache --show-stats

    - name: Package build artifacts
      run: |
        # Package the minimal set of binaries needed for testing
        tar czf build-output.tar.gz \
          out/current/bin/yosys \
          out/current/share/ \
          build/uhdm2rtlil.so \
          build/third_party/Surelog/bin/ \
          build/third_party/Surelog/third_party/UHDM/bin/

    - name: Upload build output
      uses: actions/upload-artifact@v4
      with:
        name: build-output
        path: build-output.tar.gz
        retention-days: 1

  test:
    runs-on: ubuntu-24.04
    needs: build

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install runtime dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libtcmalloc-minimal4 \
          tcl \
          libffi8 \
          libreadline8 \
          python3

    - name: Download build output
      uses: actions/download-artifact@v4
      with:
        name: build-output

    - name: Extract build output
      run: |
        tar xzf build-output.tar.gz

    - name: Run internal tests
      run: |
        cd test
        bash run_all_tests.sh

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: |
          test/**/rtlil_diff.txt
          test/**/*_from_uhdm.il
          test/**/*_from_verilog.il
          test/**/*.log
        retention-days: 7

  test-yosys:
    runs-on: ubuntu-24.04
    needs: build

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install runtime dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libtcmalloc-minimal4 \
          tcl \
          libffi8 \
          libreadline8 \
          python3

    - name: Download build output
      uses: actions/download-artifact@v4
      with:
        name: build-output

    - name: Extract build output
      run: |
        tar xzf build-output.tar.gz

    - name: Run Yosys tests
      run: |
        cd test
        bash run_all_tests.sh --yosys

    - name: Upload Yosys test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-yosys-results
        path: |
          test/**/rtlil_diff.txt
          test/**/*_from_uhdm.il
          test/**/*_from_verilog.il
          test/**/*.log
          test/run/
        retention-days: 7
